<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Saint-Valentine ğŸ’•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { animation: { 'pulse-fast': 'pulse 1s infinite' } } }
        }
    </script>
</head>
<body class="min-h-screen bg-pink-300 flex flex-col justify-center items-center text-white font-sans p-4">
    
    <!-- Mode test -->
    <div class="fixed top-4 left-4 bg-black/50 text-white p-3 rounded-lg z-50 text-sm">
        <div>ğŸ§ª MODE TEST LOCAL</div>
        <div class="text-xs mt-1">Base de donnÃ©es: localStorage</div>
    </div>

    <!-- Popup identification demandeur -->
    <div id="askerPopup" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-white/95 backdrop-blur-xl rounded-3xl p-6 md:p-8 max-w-sm w-11/12 mx-4 text-center shadow-2xl animate-pulse">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 md:mb-6">CrÃ©er ta demande ğŸ’•</h2>
            <input type="text" id="askerName" placeholder="Ton prÃ©nom..." 
                   class="w-full px-4 md:px-6 py-3 md:py-4 text-base md:text-lg text-gray-800 border-2 border-pink-200 rounded-2xl focus:border-pink-400 focus:outline-none text-center font-semibold mb-3 md:mb-4 bg-white shadow-inner">
            <input type="text" id="responderNameForLink" placeholder="PrÃ©nom de ta Valentine..." 
                   class="w-full px-4 md:px-6 py-3 md:py-4 text-base md:text-lg text-gray-800 border-2 border-pink-200 rounded-2xl focus:border-pink-400 focus:outline-none text-center font-semibold mb-3 md:mb-4 bg-white shadow-inner">
            <input type="email" id="askerEmail" placeholder="Ton email (optionnel)..." 
                   class="w-full px-4 md:px-6 py-3 md:py-4 text-base md:text-lg text-gray-800 border-2 border-pink-200 rounded-2xl focus:border-pink-400 focus:outline-none text-center font-semibold mb-4 md:mb-6 bg-white shadow-inner">
            <button onclick="createProposal()" class="px-6 md:px-8 py-3 md:py-4 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-2xl font-bold text-base md:text-lg hover:scale-105 transition-all duration-200">
                CrÃ©er la demande
            </button>
        </div>
    </div>

    <!-- Popup identification rÃ©pondeur -->
    <div id="responderPopup" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-white/95 backdrop-blur-xl rounded-3xl p-6 md:p-8 max-w-sm w-11/12 mx-4 text-center shadow-2xl animate-pulse">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 md:mb-6">Tu as reÃ§u une demande ! ğŸ’Œ</h2>
            <p class="text-gray-600 mb-4 md:mb-6">De la part de : <span id="fromName" class="font-bold text-pink-500"></span></p>
            <input type="text" id="responderName" placeholder="Ton prÃ©nom..." 
                   class="w-full px-4 md:px-6 py-3 md:py-4 text-base md:text-lg text-gray-800 border-2 border-pink-200 rounded-2xl focus:border-pink-400 focus:outline-none text-center font-semibold mb-4 md:mb-6 bg-white shadow-inner">
            <button onclick="startValentine()" class="px-6 md:px-8 py-3 md:py-4 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-2xl font-bold text-base md:text-lg hover:scale-105 transition-all duration-200">
                Voir la demande
            </button>
        </div>
    </div>
    
    <!-- Titre  -->
    <h1 id="dynamicTitle" class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl text-black font-bold mb-8 md:mb-12 drop-shadow-2xl animate-pulse hidden text-center px-4">
        <span id="responderDisplay"></span>, veux-tu Ãªtre la Valentine de <span id="askerDisplay"></span> ? ğŸ’–
    </h1>
    
    <!-- Boutons  -->
    <button id="oui" 
        class="fixed px-6 md:px-8 py-4 md:py-6 text-lg md:text-xl font-bold mt-8 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-full shadow-2xl hover:scale-125 transition-all duration-300 z-20 min-w-[120px] md:min-w-[140px] hover:shadow-pink-500/50 hidden">
        Oui ğŸ˜
    </button>
    
    <button id="non" 
        class="fixed px-6 md:px-8 py-4 md:py-6 text-lg md:text-xl font-bold mt-8 bg-gray-200 text-gray-800 rounded-full shadow-xl hover:scale-90 transition-all duration-200 z-10 min-w-[120px] md:min-w-[140px] hidden">
        Non ğŸ™„
    </button>
    
    <!-- Lien Ã  partager -->
    <div id="shareLink" class="fixed inset-0 bg-black/80 flex flex-col justify-center items-center z-30 hidden px-4">
        <div class="bg-white/95 backdrop-blur-xl rounded-3xl p-6 md:p-8 max-w-md w-11/12 mx-4 text-center shadow-2xl">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Partage ta demande ! ğŸ’Œ</h2>
            <p class="text-gray-600 mb-4">Envoie ce lien Ã  ta Valentine :</p>
            <div class="bg-gray-100 rounded-xl p-4 mb-6 break-all">
                <code id="generatedLink" class="text-sm text-pink-600 font-mono"></code>
            </div>
            <button onclick="copyLink()" class="px-6 py-3 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-2xl font-bold hover:scale-105 transition-all duration-200 mb-3">
                ğŸ“‹ Copier le lien
            </button>
            <button onclick="viewResults()" class="px-6 py-3 bg-purple-500 text-white rounded-2xl font-bold hover:scale-105 transition-all duration-200 mb-3">
                ğŸ“Š Voir mes rÃ©sultats
            </button>
            <button onclick="resetToCreate()" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-2xl font-bold hover:scale-105 transition-all duration-200">
                CrÃ©er une autre demande
            </button>
        </div>
    </div>

    <!-- RÃ©sultats pour l'expÃ©diteur -->
    <div id="resultsView" class="fixed inset-0 bg-black/80 flex flex-col justify-center items-center z-30 hidden px-4">
        <div class="bg-white/95 backdrop-blur-xl rounded-3xl p-6 md:p-8 max-w-md w-11/12 mx-4 text-center shadow-2xl max-h-[80vh] overflow-y-auto">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">RÃ©sultats de ta demande ğŸ’Œ</h2>
            <div id="resultsContent" class="text-gray-700 mb-6"></div>
            <button onclick="closeResults()" class="px-6 py-3 bg-gradient-to-r from-pink-400 to-rose-400 text-white rounded-2xl font-bold hover:scale-105 transition-all duration-200">
                Fermer
            </button>
        </div>
    </div>

    <!-- SuccÃ¨s -->
    <div id="success" class="fixed inset-0 bg-black/80 flex flex-col justify-center items-center z-30 hidden px-4">
        <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExc3Y2aWoxeHFnOGF5cGFlYW92cDJhY2IydGd4d3U2M2Z5Z2l2eDByeCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/u8u0R51ND9L2/giphy.gif" alt="SuccÃ¨s !" class="w-48 h-48 sm:w-64 sm:h-64 md:w-80 md:h-80 lg:w-96 lg:h-96 mx-auto mb-6 md:mb-8 animate-bounce">
        <h2 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-black bg-gradient-to-r from-yellow-400 to-pink-500 bg-clip-text text-transparent drop-shadow-2xl animate-pulse text-center">
            Woooww Superrr ! â¤ï¸â€ğŸ©¹
        </h2>
        <p class="text-white text-lg mt-4">De la part de <span id="finalFromName" class="font-bold"></span> Ã  <span id="finalToName" class="font-bold"></span></p>
        <p class="text-white text-sm mt-2 opacity-75">Ta rÃ©ponse a Ã©tÃ© enregistrÃ©e ! âœ¨</p>
    </div>

    <!-- Outils de test -->
    <div class="fixed bottom-4 right-4 bg-black/50 text-white p-3 rounded-lg z-50 text-xs space-y-2">
        <button onclick="clearTestData()" class="bg-red-500 px-2 py-1 rounded">ğŸ—‘ï¸ Vider donnÃ©es</button>
        <button onclick="showTestData()" class="bg-blue-500 px-2 py-1 rounded">ğŸ‘€ Voir donnÃ©es</button>
        <button onclick="createTestLink()" class="bg-green-500 px-2 py-1 rounded">ğŸ”— Lien test</button>
    </div>

    <script>
        const askerPopup = document.getElementById('askerPopup');
        const responderPopup = document.getElementById('responderPopup');
        const dynamicTitle = document.getElementById('dynamicTitle');
        const responderNameForLinkInput = document.getElementById('responderNameForLink');
        const responderDisplay = document.getElementById('responderDisplay');
        const askerDisplay = document.getElementById('askerDisplay');
        const responderNameInput = document.getElementById('responderName');
        const askerNameInput = document.getElementById('askerName');
        const askerEmailInput = document.getElementById('askerEmail');
        const ouiBtn = document.getElementById('oui');
        const nonBtn = document.getElementById('non');
        const success = document.getElementById('success');
        const shareLink = document.getElementById('shareLink');
        const generatedLink = document.getElementById('generatedLink');
        const fromName = document.getElementById('fromName');
        const finalFromName = document.getElementById('finalFromName');
        const finalToName = document.getElementById('finalToName');
        const resultsView = document.getElementById('resultsView');
        const resultsContent = document.getElementById('resultsContent');

        let currentProposal = null;

        // Mode test automatique
        window.addEventListener('load', () => {
            console.log('ğŸ” VÃ©rification des paramÃ¨tres URL...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const proposalId = urlParams.get('id');
            const askerName = urlParams.get('from');
            const responderName = urlParams.get('to');
            
            console.log('ğŸ“‹ ParamÃ¨tres dÃ©tectÃ©s:', { proposalId, askerName, responderName });
            
            if (proposalId && askerName && responderName) {
                console.log('âœ… Mode rÃ©pondeur avec lien complet');
                // Mode rÃ©pondeur avec lien complet
                currentProposal = { id: proposalId, askerName, responderName };
                askerPopup.style.display = 'none';
                
                // Afficher directement la question
                responderDisplay.textContent = responderName;
                askerDisplay.textContent = askerName;
                dynamicTitle.classList.remove('hidden');
                ouiBtn.classList.remove('hidden');
                nonBtn.classList.remove('hidden');
                
                // Position initiale boutons
                const isMobile = window.innerWidth < 768;
                const ouiWidth = isMobile ? 120 : 140;
                const spacing = isMobile ? 10 : 20;
                
                ouiBtn.style.left = `calc(50% - ${ouiWidth + spacing}px)`;
                ouiBtn.style.top = 'calc(50% + 30px)';
                nonBtn.style.left = `calc(50% + ${spacing}px)`;
                nonBtn.style.top = 'calc(50% + 30px)';
            } else if (proposalId && askerName) {
                console.log('ğŸ“ Mode rÃ©pondeur ancienne version');
                // Mode rÃ©pondeur ancienne version
                currentProposal = { id: proposalId, askerName };
                fromName.textContent = askerName;
                askerPopup.style.display = 'none';
                responderPopup.classList.remove('hidden');
                responderNameInput.focus();
            } else {
                console.log('ğŸ‘¤ Mode demandeur');
                // Mode demandeur
                askerPopup.classList.remove('hidden');
                askerNameInput.focus();
            }
        });

        function createProposal() {
            const askerName = askerNameInput.value.trim();
            const responderName = responderNameForLinkInput.value.trim();
            const askerEmail = askerEmailInput.value.trim();
            
            if (askerName === '') {
                alert('Entre ton prÃ©nom stp ğŸ’•');
                return;
            }
            
            if (responderName === '') {
                alert('Entre le prÃ©nom de ta Valentine stp ğŸ’•');
                return;
            }
            
            // GÃ©nÃ©rer un ID unique
            const proposalId = 'valentine_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?id=${proposalId}&from=${encodeURIComponent(askerName)}&to=${encodeURIComponent(responderName)}`;
            
            // Sauvegarder la proposition (localStorage pour test)
            localStorage.setItem(proposalId, JSON.stringify({
                askerName,
                responderName,
                askerEmail,
                createdAt: new Date().toISOString()
            }));
            
            // Sauvegarder pour rÃ©sultats
            localStorage.setItem('current_asker', askerName);
            
            // Afficher le lien Ã  partager
            generatedLink.textContent = shareUrl;
            askerPopup.style.display = 'none';
            shareLink.classList.remove('hidden');
        }

        function startValentine() {
            const responderName = responderNameInput.value.trim();
            if (responderName === '') {
                alert('Entre ton prÃ©nom stp ğŸ’•');
                return;
            }
            
            // Masquer les popups
            responderPopup.style.display = 'none';
            
            // Afficher la question personnalisÃ©e
            responderDisplay.textContent = responderName;
            dynamicTitle.classList.remove('hidden');
            ouiBtn.classList.remove('hidden');
            nonBtn.classList.remove('hidden');
            
            // Position initiale boutons
            const isMobile = window.innerWidth < 768;
            const ouiWidth = isMobile ? 120 : 140;
            const spacing = isMobile ? 10 : 20;
            
            ouiBtn.style.left = `calc(50% - ${ouiWidth + spacing}px)`;
            ouiBtn.style.top = 'calc(50% + 30px)';
            nonBtn.style.left = `calc(50% + ${spacing}px)`;
            nonBtn.style.top = 'calc(50% + 30px)';
        }

        function copyLink() {
            navigator.clipboard.writeText(generatedLink.textContent).then(() => {
                alert('Lien copiÃ© ! ğŸ“‹');
            });
        }

        function resetToCreate() {
            shareLink.classList.add('hidden');
            askerPopup.style.display = 'flex';
            askerNameInput.value = '';
            responderNameForLinkInput.value = '';
            askerEmailInput.value = '';
            askerNameInput.focus();
        }

        function moveNonButton() {
            const isMobile = window.innerWidth < 768;
            const buttonWidth = isMobile ? 120 : 180;
            const maxX = window.innerWidth - buttonWidth;
            const maxY = window.innerHeight - buttonWidth;
            const newX = Math.random() * maxX;
            const newY = Math.random() * maxY;
            nonBtn.style.left = newX + 'px';
            nonBtn.style.top = newY + 'px';
        }

        function growOuiButton() {
            const currentScale = parseFloat(ouiBtn.getAttribute('data-scale') || 1);
            if (currentScale < 2) {
                const newScale = Math.min(currentScale + 0.2, 2);
                ouiBtn.setAttribute('data-scale', newScale);
                ouiBtn.style.transform = `scale(${newScale})`;
            }
        }

        // Bouton Non fuit au survol (desktop)
        nonBtn.addEventListener('mouseenter', moveNonButton);

        // Bouton Non fuit au clic (mobile/tablette)
        nonBtn.addEventListener('click', (e) => {
            e.preventDefault();
            moveNonButton();
            growOuiButton();
            
            // Enregistrer la tentative de "Non" (optionnel)
            if (currentProposal?.id && Math.random() < 0.1) {
                const nonAttempt = {
                    proposalId: currentProposal.id,
                    askerName: currentProposal.askerName,
                    responderName: currentProposal?.responderName || 'Inconnu',
                    response: 'NON_TENTATIVE',
                    attemptedAt: new Date().toISOString()
                };
                
                const responses = JSON.parse(localStorage.getItem('valentine_responses') || '[]');
                responses.push(nonAttempt);
                localStorage.setItem('valentine_responses', JSON.stringify(responses));
            }
        });

        // Bouton Oui grandit au survol (desktop)
        ouiBtn.addEventListener('mouseenter', growOuiButton);

        // Bouton Oui grandit au toucher (mobile/tablette)
        ouiBtn.addEventListener('touchstart', growOuiButton);

        // SuccÃ¨s au clic sur Oui
        ouiBtn.addEventListener('click', () => {
            document.querySelectorAll('button').forEach(b => b.style.display = 'none');
            dynamicTitle.style.display = 'none';
            
            // Afficher les noms dans le message de succÃ¨s
            const responderName = currentProposal?.responderName || responderNameInput?.value.trim() || 'Quelqu\'un';
            finalFromName.textContent = currentProposal?.askerName || 'Quelqu\'un';
            finalToName.textContent = responderName;
            
            // Enregistrer la rÃ©ponse
            if (currentProposal?.id) {
                const response = {
                    proposalId: currentProposal.id,
                    askerName: currentProposal.askerName,
                    responderName: responderName,
                    response: 'OUI',
                    respondedAt: new Date().toISOString(),
                    responderEmail: null
                };
                
                // Sauvegarder la rÃ©ponse
                const responses = JSON.parse(localStorage.getItem('valentine_responses') || '[]');
                responses.push(response);
                localStorage.setItem('valentine_responses', JSON.stringify(responses));
                
                // Marquer la proposition comme rÃ©pondue
                const proposal = JSON.parse(localStorage.getItem(currentProposal.id) || '{}');
                proposal.response = 'OUI';
                proposal.respondedAt = response.respondedAt;
                proposal.actualResponderName = responderName;
                localStorage.setItem(currentProposal.id, JSON.stringify(proposal));
            }
            
            success.classList.remove('hidden');
        });

        // Gestion des touches Enter
        askerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createProposal();
        });
        
        responderNameForLinkInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createProposal();
        });
        
        askerEmailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createProposal();
        });
        
        responderNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startValentine();
        });

        // Fonction pour voir les rÃ©sultats
        function viewResults() {
            const askerName = localStorage.getItem('current_asker');
            const responses = JSON.parse(localStorage.getItem('valentine_responses') || '[]');
            const myResponses = responses.filter(r => r.askerName === askerName);
            
            if (myResponses.length === 0) {
                resultsContent.innerHTML = `
                    <p class="text-gray-600">Aucune rÃ©ponse enregistrÃ©e pour le moment.</p>
                    <p class="text-sm text-gray-500 mt-2">Les rÃ©ponses apparaÃ®tront ici dÃ¨s que tes Valentines rÃ©pondront !</p>
                `;
            } else {
                let html = '<div class="space-y-4">';
                myResponses.forEach(response => {
                    const date = new Date(response.respondedAt || response.attemptedAt);
                    const dateStr = date.toLocaleDateString('fr-FR') + ' Ã  ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    if (response.response === 'OUI') {
                        html += `
                            <div class="bg-green-100 border border-green-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-green-800 font-bold">âœ… OUI !</span>
                                    <span class="text-xs text-gray-500">${dateStr}</span>
                                </div>
                                <p class="text-green-700"><strong>${response.responderName}</strong> a acceptÃ© ta demande !</p>
                                <p class="text-sm text-green-600 mt-1">De : ${response.askerName} â†’ ${response.responderName}</p>
                            </div>
                        `;
                    } else if (response.response === 'NON_TENTATIVE') {
                        html += `
                            <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-yellow-800 font-bold">ğŸƒ Tentative de Non</span>
                                    <span class="text-xs text-gray-500">${dateStr}</span>
                                </div>
                                <p class="text-yellow-700"><strong>${response.responderName}</strong> a essayÃ© de dire non... mais le bouton a fui !</p>
                            </div>
                        `;
                    }
                });
                html += '</div>';
                
                const stats = {
                    oui: myResponses.filter(r => r.response === 'OUI').length,
                    tentatives: myResponses.filter(r => r.response === 'NON_TENTATIVE').length
                };
                
                html += `
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-2">ğŸ“Š Statistiques</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-pink-100 rounded-lg p-3">
                                <div class="text-2xl font-bold text-pink-600">${stats.oui}</div>
                                <div class="text-sm text-pink-700">Oui</div>
                            </div>
                            <div class="bg-yellow-100 rounded-lg p-3">
                                <div class="text-2xl font-bold text-yellow-600">${stats.tentatives}</div>
                                <div class="text-sm text-yellow-700">Tentatives Non</div>
                            </div>
                        </div>
                    </div>
                `;
                
                resultsContent.innerHTML = html;
            }
            
            shareLink.classList.add('hidden');
            resultsView.classList.remove('hidden');
        }
        
        // Fonction pour fermer les rÃ©sultats
        function closeResults() {
            resultsView.classList.add('hidden');
            shareLink.classList.remove('hidden');
        }

        // ===== OUTILS DE TEST =====
        
        function clearTestData() {
            if (confirm('Vider toutes les donnÃ©es de test ?')) {
                localStorage.clear();
                alert('DonnÃ©es effacÃ©es ! ğŸ—‘ï¸');
                location.reload();
            }
        }
        
        function showTestData() {
            const data = {
                current_asker: localStorage.getItem('current_asker'),
                responses: JSON.parse(localStorage.getItem('valentine_responses') || '[]'),
                proposals: {}
            };
            
            // Collecter toutes les propositions
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('valentine_')) {
                    data.proposals[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            
            console.log('ğŸ“Š DonnÃ©es de test:', data);
            alert('DonnÃ©es affichÃ©es dans la console ! ğŸ‘€');
        }
        
        function createTestLink() {
            const testId = 'valentine_test_' + Date.now();
            const testUrl = `${window.location.origin}${window.location.pathname}?id=${testId}&from=Jean&to=Marie`;
            
            // CrÃ©er une proposition de test
            localStorage.setItem(testId, JSON.stringify({
                askerName: 'Jean',
                responderName: 'Marie',
                askerEmail: 'jean@test.com',
                createdAt: new Date().toISOString()
            }));
            
            // CrÃ©er aussi un lien avec tes noms
            const customUrl = `${window.location.origin}${window.location.pathname}?id=valentine_${Date.now()}_custom&from=adom&to=majoie`;
            localStorage.setItem(`valentine_${Date.now()}_custom`, JSON.stringify({
                askerName: 'adom',
                responderName: 'majoie',
                askerEmail: 'adom@test.com',
                createdAt: new Date().toISOString()
            }));
            
            const message = `Liens de test copiÃ©s ! ğŸ“‹\n\n` +
                          `ğŸ§ª Lien test Jeanâ†’Marie:\n${testUrl}\n\n` +
                          `ğŸ’• Lien personnalisÃ© adomâ†’majoie:\n${customUrl}\n\n` +
                          `Ouvre-les dans des NOUVEAUX onglets pour tester le mode rÃ©pondeur !`;
            
            navigator.clipboard.writeText(testUrl).then(() => {
                alert(message);
            });
        }
    </script>
</body>
</html>
